# 47 Doors Hackathon - Smoke Test CI
# Runs on every push/PR to validate the environment works correctly
# This catches issues before participants encounter them in Codespaces

name: Smoke Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

env:
  USE_MOCK_MODE: "true"
  PYTHONDONTWRITEBYTECODE: "1"

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests
        run: |
          python -m pytest tests/test_agents.py tests/test_evals.py tests/test_models.py -v --tb=short

      - name: Run spec compliance tests
        run: |
          python -m pytest tests/test_spec_compliance.py -v --tb=short

      - name: Test mock services
        run: |
          python -c "
          from app.services.mock.llm_service import MockLLMService
          from app.services.mock.knowledge_service import MockKnowledgeService
          import asyncio

          async def test_mocks():
              # Test LLM service
              llm = MockLLMService()
              result = await llm.classify_intent('I forgot my password')
              assert result.intent == 'password_reset', f'Expected password_reset, got {result.intent}'
              assert result.confidence > 0.5, f'Expected confidence > 0.5, got {result.confidence}'

              # Test knowledge service
              kb = MockKnowledgeService()
              articles = await kb.search('password reset')
              assert len(articles) > 0, 'Expected at least one KB article'

              print('Mock services: OK')

          asyncio.run(test_mocks())
          "

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || echo "Linting complete with warnings"

      - name: Run type check
        run: npm run type-check || echo "Type checking complete"

      - name: Build frontend
        run: npm run build

  e2e-smoke:
    name: E2E Smoke Test
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Start backend server
        working-directory: backend
        run: |
          USE_MOCK_MODE=true python -m uvicorn app.main:app --port 8000 &
          sleep 5

      - name: Wait for backend
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8000/api/health | grep -q "healthy\|ok"; then
              echo "Backend is ready"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done

      - name: Run E2E smoke tests
        working-directory: frontend
        run: |
          npx playwright test tests/e2e/chat.spec.ts --project=chromium --reporter=list
        env:
          VITE_API_URL: http://localhost:8000
        continue-on-error: true

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

  lab-validation:
    name: Lab Content Validation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate lab structure
        run: |
          echo "Checking lab directories..."

          LABS="00-setup 01-understanding-agents 02-azure-mcp-setup 03-spec-driven-development 04-build-rag-pipeline 05-agent-orchestration 06-deploy-with-azd 07-mcp-server"

          for lab in $LABS; do
            if [ -d "labs/$lab" ] && [ -f "labs/$lab/README.md" ]; then
              echo "✓ Lab $lab: OK"
            else
              echo "✗ Lab $lab: MISSING"
              exit 1
            fi
          done

      - name: Validate solution files
        run: |
          echo "Checking solution files..."

          # Lab 04 solutions
          [ -f "labs/04-build-rag-pipeline/solution/search_tool.py" ] && echo "✓ Lab 04 search_tool.py" || echo "⚠ Missing"
          [ -f "labs/04-build-rag-pipeline/solution/retrieve_agent.py" ] && echo "✓ Lab 04 retrieve_agent.py" || echo "⚠ Missing"

          # Lab 05 solutions
          [ -f "labs/05-agent-orchestration/solution/query_agent.py" ] && echo "✓ Lab 05 query_agent.py" || echo "⚠ Missing"
          [ -f "labs/05-agent-orchestration/solution/router_agent.py" ] && echo "✓ Lab 05 router_agent.py" || echo "⚠ Missing"
          [ -f "labs/05-agent-orchestration/solution/action_agent.py" ] && echo "✓ Lab 05 action_agent.py" || echo "⚠ Missing"
          [ -f "labs/05-agent-orchestration/solution/pipeline.py" ] && echo "✓ Lab 05 pipeline.py" || echo "⚠ Missing"

          # Lab 07 solutions
          [ -f "labs/07-mcp-server/solution/mcp_server.py" ] && echo "✓ Lab 07 mcp_server.py" || echo "⚠ Missing"

      - name: Check KB articles count
        run: |
          ARTICLE_COUNT=$(find labs/04-build-rag-pipeline/data -name "*.md" 2>/dev/null | wc -l)
          echo "Knowledge base articles: $ARTICLE_COUNT"
          if [ "$ARTICLE_COUNT" -ge 50 ]; then
            echo "✓ KB article count OK (50+ required)"
          else
            echo "⚠ KB articles below 50 - found $ARTICLE_COUNT"
          fi

  codespaces-ready:
    name: Codespaces Ready Check
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, lab-validation]

    steps:
      - uses: actions/checkout@v4

      - name: Validate devcontainer.json
        run: |
          if [ -f ".devcontainer/devcontainer.json" ]; then
            echo "✓ devcontainer.json exists"
            # Basic JSON validation
            python -c "import json; json.load(open('.devcontainer/devcontainer.json'))" && echo "✓ Valid JSON"
          else
            echo "✗ devcontainer.json missing"
            exit 1
          fi

      - name: Summary
        run: |
          echo "=========================================="
          echo "Smoke Test Complete"
          echo "=========================================="
          echo ""
          echo "The environment has passed all critical checks."
          echo "This commit is ready for Codespaces deployment."
          echo ""
          echo "Participants can:"
          echo "  1. Open in Codespaces"
          echo "  2. Wait for post-create setup"
          echo "  3. Run 'npm run smoke-test' to verify"
          echo "  4. Start with Lab 00"
